{% comment %}Roadmap Widget{% endcomment %}

{% assign roadmap_id = "676937a32efc0b9e53a85a40" %}
{% assign roadmap_id_source = "Default" %}
{% assign email = "" %}
{% assign first_name = "" %}
{% assign last_name = "" %}
{% assign iframe_url = "https://cdn.roadmap-dev.space/widget/roadmap.js" %}

{% if shop.metafields.roadmap.settings %}
  {% if shop.metafields.roadmap.settings.value %}
    {% if shop.metafields.roadmap.settings.value.roadmapId %}
      {% assign roadmap_id = shop.metafields.roadmap.settings.value.roadmapId %}
      {% assign roadmap_id_source = "Metafields" %}
    {% endif %}
    {% if shop.metafields.roadmap.settings.value.iframeUrl %}
      {% assign iframe_url = shop.metafields.roadmap.settings.value.iframeUrl %}
    {% endif %}
  {% endif %}
{% endif %}

{% if block.settings.roadmap_id != blank %}
  {% assign roadmap_id = block.settings.roadmap_id %}
  {% assign roadmap_id_source = "Block Settings" %}
{% endif %}

<!-- Get customer information if logged in -->
{% if customer %}
  {% assign email = customer.email | default: "" %}
  {% assign first_name = customer.first_name | default: "" %}
  {% assign last_name = customer.last_name | default: "" %}
{% endif %}

{% comment %} <!-- Debug information toggle button -->
<button id="toggle-debug" style="background-color: #f5f5f5; border: 1px solid #ddd; padding: 5px 10px; margin-bottom: 5px; cursor: pointer; font-size: 12px;">
  Show Debug Info
</button>

<!-- Debug information -->
<div id="debug-info" style="display: none; background-color: #f5f5f5; padding: 10px; margin: 10px 0; border: 1px solid #ddd; font-family: monospace; white-space: pre-wrap;">
  <h3>Debug Information</h3>
  <p><strong>All Metafields:</strong> {{ shop.metafields | json }}</p>
  <p><strong>Roadmap Metafields:</strong> {{ shop.metafields.roadmap | json }}</p>
  <p><strong>Roadmap Settings:</strong> {{ shop.metafields.roadmap.settings | json }}</p>
  <p><strong>Roadmap Settings value:</strong> {{ shop.metafields.roadmap.settings.value | json }}</p>
  <p><strong>Roadmap Settings value roadmapId:</strong> {{ shop.metafields.roadmap.settings.value.roadmapId | json }}</p>
  <p><strong>Roadmap Settings value iframeUrl:</strong> {{ shop.metafields.roadmap.settings.value.iframeUrl | json }}</p>
  <p><strong>Current Roadmap ID:</strong> {{ roadmap_id }}</p>
  <p><strong>Roadmap ID Source:</strong> <span style="color: blue; font-weight: bold;">{{ roadmap_id_source }}</span></p>
  <p><strong>Current iframe URL:</strong> {{ iframe_url }}</p>
  <p><strong>Email:</strong> {{ email }}</p>
  <p><strong>First Name:</strong> {{ first_name }}</p>
  <p><strong>Last Name:</strong> {{ last_name }}</p>
  <p><strong>Customer Info:</strong> {{ customer | json }}</p>
</div> {% endcomment %}

{% comment %} <script>
  // Debug information toggle functionality
  document.getElementById('toggle-debug').addEventListener('click', function() {
    var debugInfo = document.getElementById('debug-info');
    var toggleBtn = document.getElementById('toggle-debug');
    if (debugInfo.style.display === 'none') {
      debugInfo.style.display = 'block';
      toggleBtn.textContent = 'Hide Debug Info';
    } else {
      debugInfo.style.display = 'none';
      toggleBtn.textContent = 'Show Debug Info';
    }
  });
</script>

<!-- Roadmap ID source information -->
<div style="background-color: #e8f4ff; padding: 8px 12px; margin-bottom: 10px; border-left: 4px solid #2e72d2; font-size: 14px;">
  <p style="margin: 0; padding: 0;">
    <strong>Roadmap ID:</strong> {{ roadmap_id }}
    <span style="background-color: #2e72d2; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 8px; font-size: 12px;">{{ roadmap_id_source }}</span>
  </p>
  <p style="margin: 5px 0 0 0; padding: 0; font-size: 12px; color: #666;">
    <strong>Using iframe URL:</strong> {{ iframe_url }}
  </p>
</div> {% endcomment %}

<!-- Create container first -->
<div id="roadmap-container" style="width: 100%; height: 600px;"></div>

<!-- Ensure script loads and executes correctly -->
<script>
  // Define available CDN URLs
  var ROADMAP_PROD_URL = 'https://cdn.roadmap.space/widget/roadmap.js';
  var ROADMAP_DEV_URL = 'https://cdn.roadmap-dev.space/widget/roadmap.js';
  
  // iframe URL from metafield
  var IFRAME_URL = '{{ iframe_url }}';
  
  // Create script tag and set attributes
  function loadRoadmapScript(url, isRetry) {
    console.log('Attempting to load Roadmap script from: ' + url);
    console.log('Roadmap ID: {{ roadmap_id }} (Source: {{ roadmap_id_source }})');
    
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = url;
    script.id = 'public-roadmap';
    script.setAttribute('data-id', '{{ roadmap_id }}');
    script.setAttribute('data-embedded', 'true');
    script.setAttribute('data-container', 'roadmap-container');
    script.setAttribute('data-email', '{{ email }}');
    script.setAttribute('data-first', '{{ first_name }}');
    script.setAttribute('data-last', '{{ last_name }}');
    script.setAttribute('data-company', 'company');
    script.setAttribute('data-revenue', '123');
    
    // Listen for script load complete event
    script.onload = function() {
      console.log('Roadmap script loaded successfully from: ' + url);
      // If you need to execute additional code after the script loads, add it here
    };
    
    // Listen for script load error
    script.onerror = function() {
      console.error('Failed to load Roadmap script from: ' + url);
      
      // If custom URL fails and not yet retried, try dev environment URL
      if (url === IFRAME_URL && !isRetry && url !== ROADMAP_DEV_URL) {
        console.log('Custom URL failed, trying dev URL as fallback...');
        loadRoadmapScript(ROADMAP_DEV_URL, true);
      }
      // If dev environment URL fails and not yet retried, try production environment URL
      else if (url === ROADMAP_DEV_URL && !isRetry) {
        console.log('Trying production URL as fallback...');
        loadRoadmapScript(ROADMAP_PROD_URL, true);
      } else if (url === ROADMAP_PROD_URL && !isRetry && IFRAME_URL !== ROADMAP_PROD_URL) {
        console.log('Production URL failed, trying custom URL one more time...');
        loadRoadmapScript(IFRAME_URL, true);
      } else {
        // All URLs failed, display error message
        document.getElementById('roadmap-container').innerHTML = 
          '<div style="text-align: center; padding: 20px; color: #d00;">' +
          '<p>Sorry, unable to load Roadmap component.</p>' +
          '<p>Roadmap ID: {{ roadmap_id }} (Source: {{ roadmap_id_source }})</p>' +
          '<p>Attempted URL: ' + url + '</p>' +
          '<p>Please try again later or contact support.</p>' +
          '</div>';
      }
    };
    
    // Add script to document
    document.body.appendChild(script);
  }
  
  // Execute when page loads
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(function() {
      // Use iframe URL from metafield
      loadRoadmapScript(IFRAME_URL, false);
    }, 1);
  } else {
    document.addEventListener('DOMContentLoaded', function() {
      // Use iframe URL from metafield
      loadRoadmapScript(IFRAME_URL, false);
    });
  }
</script>

{% schema %}
{
  "name": "Roadmap Widget",
  "target": "section",
}
{% endschema %}